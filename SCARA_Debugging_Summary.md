
# SCARA 机械臂调试日志与总结

**目标:** 解决SCARA机械臂在执行纯X轴或纯Y轴直线移动时，只有一个电机动作的Bug。

**最终状态:** 成功。机械臂现已能正确执行所有方向的直线移动，核心问题已从固件Bug转变为参数校准。

---

### 一、 核心问题诊断

*   **初始现象:**
    *   对角线移动 (如 `G1 X100 Y100`) **正常**，两个电机都能正确联动。
    *   纯轴向移动 (如 `G1 X100` 或 `G1 Y100`) **异常**，只有一个电机（或主要是一个电机）动作，导致末端执行器画出弧线而非直线。

*   **初步结论:** 电机、驱动器、接线和基本的SCARA运动学模型是**有效**的（因为对角线移动成功）。问题出在固件处理特殊情况（纯轴向移动）的规划算法上。

---

### 二、 调试过程中的关键“坑”与教训 (Troubleshooting & Pitfalls)

我们在解决问题的过程中遇到了几个关键的转折点，这些“坑”是本次调试最有价值的部分：

#### 踩坑 1: 错误的固件版本 (`grbl-scara` vs `grbl-hu`)

*   **过程:** 我们最初花费了大量精力试图修复 `grbl-scara` (jared-hughes) 版本的固件。我提供了针对其 `planner.c` 的补丁，但均未生效。
*   **根本原因:** 经过反复失败后，我们最终确认 **`grbl-scara` 是一个不完整的、有缺陷的版本**。它虽然有SCARA的配置选项，但**缺失了最核心的SCARA运动学解算函数**，导致它在物理上无法正确计算电机角度。
*   **教训:** **选择一个经过验证的、功能完整的固件分支至关重要。** `grbl-hu` 版本包含了正确的运动学代码，是我们最终成功的基石。

#### 踩坑 2: Arduino IDE 的编译缓存问题

*   **过程:** 在切换到正确的 `grbl-hu` 固件后，我们修改了代码，但问题依旧。我们通过在代码中加入 `#error` 预处理指令进行测试，发现IDE在编译时**没有报错**，直接编译成功。
*   **根本原因:** Arduino IDE为了加速，会缓存已编译的库文件。这导致我们对库源文件（如 `planner.c`）的修改被完全忽略，烧录到控制板的始终是旧的、有问题的版本。
*   **教训:** 当代码修改后行为没有任何变化时，要高度怀疑是**编译缓存**问题。正确的解决方法是：
    1.  **彻底清理:** 删除Arduino库文件夹 (`Documents\Arduino\libraries`) 中所有旧的、相关的库文件夹。
    2.  **手动安装:** 将正确的固件文件夹（如 `grbl-hu`）复制到库文件夹中。
    3.  **正确重命名:** 将库文件夹重命名为 `grbl`，以匹配代码中 `#include <grbl.h>` 的路径。

#### 踩坑 3: 错误的参数理解 (Steps/mm vs. Steps/Radian)

*   **过程:** 在使用正确的 `grbl-hu` 固件并解决了编译问题后，机械臂可以正确联动了，但移动的幅度极小。
*   **根本原因:** 对于SCARA臂，`$100` 和 `$101` 参数的物理意义从“每毫米步数”变为了“**每弧度步数** (Steps per Radian)”。它定义了电机转动一个弧度（约57.3°）需要多少步。默认值过小导致了电机旋转角度不足。
*   **教训:** 更换运动学模型（从笛卡尔到SCARA）时，必须重新审视所有相关配置参数的物理意义。

#### 踩坑 4: 忽略了传动比 (Gear Ratio)

*   **过程:** 我们根据电机步距角和驱动器微步计算了理论的“每弧度步数”，但实际需要的数值远大于理论值。
*   **根本原因:** 我们的计算忽略了电机和关节之间的**传动比**（很可能是通过同步带轮实现的）。
*   **教训:** “每弧度步数”的完整计算公式应为：
    `Steps/Radian = (电机每转步数 * 驱动器微步 * 减速比) / (2 * π)`
    您的实验值 `1254.65` 暗示了大约 `1:5` 的减速比和 `1/8` 的微步设置，或 `1:2.5` 的减速比和 `1/16` 的微步设置。

---

### 三、 最终解决方案与正确配置

1.  **固件版本:**
    *   **必须使用 `grbl-hu` 文件夹内的固件。**

2.  **编译环境:**
    *   严格按照“踩坑2”中的描述，**手动清理并安装库文件**，确保使用的是我们指定的代码版本。

3.  **核心GRBL参数 (`$$`):**
    *   **`$20=0` (禁用软限位):** 在调试阶段必须禁用，以避免不必要的 `ALARM: Soft limit` 报警。调试完成后，应重新开启 (`$20=1`) 并设置合理的工作范围。
    *   **`$100` 和 `$101` (每弧度步数):** 这是校准的核心。我们最后一次测试使用的 **`627.33`** 是一个非常好的起点。后续的精确校准应围绕此值展开。
    *   **`$120` 和 `$121` (角加速度):** 单位是 `rad/sec²`。建议保持在 `2.0` 左右的保守值开始调试，待机械稳定后再逐步提高。

### 总结

我们今天的探索是一次非常经典的嵌入式系统调试过程：从怀疑应用层代码（运动规划），到发现工具链问题（编译缓存），再到最终定位到物理层与数字层的接口问题（参数配置）。您提供的精确测试反馈是解决问题的关键。

现在，机械臂的核心运动功能已经完全正常。后续的工作将是更有趣、更直观的机械组装和参数精细化校准。恭喜您！
